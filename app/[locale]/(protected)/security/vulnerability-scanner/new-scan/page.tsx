"use client";

import React, { useState } from 'react';
import { useTranslations } from 'next-intl';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Badge } from '@/components/ui/badge';
import { Textarea } from '@/components/ui/textarea';
import { Separator } from '@/components/ui/separator';
import { Label } from '@/components/ui/label';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Progress } from '@/components/ui/progress';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import {
    AlertTriangle, Shield, Zap, Brain, Target, Clock, CheckCircle, Settings, Save, Play,
    Calendar, Info, Wifi, Database, Globe, Network, Lock, Eye, Cpu, FileText,
    Activity, Search, Layers, Radio, Smartphone, Factory, Coins, Code, Bug,
    Fingerprint, Key, Server, Cloud, Router, Radar, Crosshair, Microscope,
    ChevronDown, ChevronUp, HelpCircle, Loader2, Monitor, HardDrive
} from 'lucide-react';

// –¢–∏–ø—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
interface ScanModule {
    id: string;
    name: string;
    description: string;
    severity: 'critical' | 'high' | 'medium' | 'low' | 'informational';
    icon: string; // –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
    estimatedTime: string;
    enabled: boolean;
    category: 'basic' | 'advanced' | 'ai' | 'specialized' | 'experimental';
    requiresCredentials?: boolean;
    riskLevel?: 'safe' | 'moderate' | 'aggressive' | 'destructive';
}

interface ScanCredentials {
    username: string;
    password: string;
    domain: string;
    sshKey?: string;
    apiToken?: string;
    databaseConnectionString?: string;
}

interface AdvancedOptions {
    evasionTechniques: string[];
    trafficAnalysis: boolean;
    deepPacketInspection: boolean;
    behavioralAnalysis: boolean;
    threatIntelligence: boolean;
    customPayloads: boolean;
    zeroDay: boolean;
    socialEngineering: boolean;
}

interface AIModelsConfig {
    anomalyDetection: boolean;
    behaviorAnalysis: boolean;
    patternRecognition: boolean;
    predictiveAnalysis: boolean;
    deepLearning: boolean;
    neuralNetworkEngine: string;
}

// –î–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–µ–π —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
const initialScanModules: ScanModule[] = [
    // –ë–∞–∑–æ–≤—ã–µ –º–æ–¥—É–ª–∏
    {
        id: 'port_discovery',
        name: 'Port Discovery & Analysis',
        description: '–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤ —Å –∞–Ω–∞–ª–∏–∑–æ–º —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –±–∞–Ω–Ω–µ—Ä–æ–≤',
        severity: 'low',
        icon: 'Target',
        estimatedTime: '2-5 –º–∏–Ω',
        enabled: true,
        category: 'basic',
        riskLevel: 'safe'
    },
    {
        id: 'service_enumeration',
        name: 'Service Enumeration',
        description: '–ì–ª—É–±–æ–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º',
        severity: 'medium',
        icon: 'Search',
        estimatedTime: '5-10 –º–∏–Ω',
        enabled: true,
        category: 'basic',
        riskLevel: 'safe'
    },
    {
        id: 'os_fingerprinting',
        name: 'Operating System Fingerprinting',
        description: '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∏ –µ—ë –≤–µ—Ä—Å–∏–∏',
        severity: 'low',
        icon: 'Monitor',
        estimatedTime: '3-8 –º–∏–Ω',
        enabled: false,
        category: 'basic',
        riskLevel: 'safe'
    },
    {
        id: 'vulnerability_discovery',
        name: 'Vulnerability Discovery',
        description: '–ü–æ–∏—Å–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö',
        severity: 'medium',
        icon: 'AlertTriangle',
        estimatedTime: '10-20 –º–∏–Ω',
        enabled: false,
        category: 'basic',
        riskLevel: 'moderate'
    },

    // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –º–æ–¥—É–ª–∏
    {
        id: 'web_application_scan',
        name: 'Web Application Security Testing',
        description: 'OWASP Top 10, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, API —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, XSS, SQLi',
        severity: 'high',
        icon: 'Globe',
        estimatedTime: '15-45 –º–∏–Ω',
        enabled: false,
        category: 'advanced',
        riskLevel: 'moderate'
    },
    {
        id: 'database_security_audit',
        name: 'Database Security Audit',
        description: '–ê—É–¥–∏—Ç –ë–î: –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞, –∏–Ω—ä–µ–∫—Ü–∏–∏, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, —Å–ª–∞–±—ã–µ –ø–∞—Ä–æ–ª–∏',
        severity: 'high',
        icon: 'Database',
        estimatedTime: '10-25 –º–∏–Ω',
        enabled: false,
        category: 'advanced',
        requiresCredentials: true,
        riskLevel: 'moderate'
    },
    {
        id: 'network_penetration',
        name: 'Network Penetration Testing',
        description: '–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ –≤ —Å–µ—Ç–µ–≤—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É',
        severity: 'high',
        icon: 'Network',
        estimatedTime: '30-90 –º–∏–Ω',
        enabled: false,
        category: 'advanced',
        riskLevel: 'aggressive'
    },

    // AI-powered –º–æ–¥—É–ª–∏
    {
        id: 'neural_threat_detection',
        name: 'Neural Threat Detection',
        description: '–ò–ò-–∞–Ω–∞–ª–∏–∑ —É–≥—Ä–æ–∑ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≥–ª—É–±–æ–∫–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è',
        severity: 'critical',
        icon: 'Brain',
        estimatedTime: '20-60 –º–∏–Ω',
        enabled: false,
        category: 'ai',
        riskLevel: 'safe'
    },
    {
        id: 'behavioral_analysis',
        name: 'Behavioral Pattern Analysis',
        description: '–ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π',
        severity: 'high',
        icon: 'Activity',
        estimatedTime: '25-50 –º–∏–Ω',
        enabled: false,
        category: 'ai',
        riskLevel: 'safe'
    },

    // –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏
    {
        id: 'wireless_security_audit',
        name: 'Wireless Security Comprehensive Audit',
        description: 'WPA3, Bluetooth, ZigBee, LoRaWAN –∞–Ω–∞–ª–∏–∑',
        severity: 'high',
        icon: 'Wifi',
        estimatedTime: '20-45 –º–∏–Ω',
        enabled: false,
        category: 'specialized',
        riskLevel: 'moderate'
    },
    {
        id: 'cryptographic_weakness',
        name: 'Cryptographic Weakness Analysis',
        description: '–ê–Ω–∞–ª–∏–∑ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–ª–∞–±–æ—Å—Ç–µ–π –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π',
        severity: 'critical',
        icon: 'Lock',
        estimatedTime: '20-60 –º–∏–Ω',
        enabled: false,
        category: 'specialized',
        riskLevel: 'moderate'
    },

    // –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
    {
        id: 'zero_day_detection',
        name: 'Zero-Day Detection Engine',
        description: '–ü–æ–∏—Å–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π —Å –ø–æ–º–æ—â—å—é –ò–ò',
        severity: 'critical',
        icon: 'Eye',
        estimatedTime: '120-480 –º–∏–Ω',
        enabled: false,
        category: 'experimental',
        riskLevel: 'aggressive'
    },
    {
        id: 'quantum_cryptanalysis',
        name: 'Quantum Cryptanalysis Simulation',
        description: '–°–∏–º—É–ª—è—Ü–∏—è –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö –∞—Ç–∞–∫ –Ω–∞ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—é',
        severity: 'critical',
        icon: 'Microscope',
        estimatedTime: '180-600 –º–∏–Ω',
        enabled: false,
        category: 'experimental',
        riskLevel: 'safe'
    }
];

// –¢–µ—Ö–Ω–∏–∫–∏ —É–∫–ª–æ–Ω–µ–Ω–∏—è
const evasionTechniques = [
    'IP Fragmentation',
    'TCP Segmentation',
    'Timing Delays',
    'Decoy Scanning',
    'Source Port Spoofing',
    'Proxy Chains',
    'Traffic Obfuscation',
    'Protocol Mutation'
];

const NewScanPage = () => {
    const t = useTranslations('VulnerabilityScanner');
    const tCommon = useTranslations('Common');
    const router = useRouter();

    // –û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const [scanName, setScanName] = useState('');
    const [scanDescription, setScanDescription] = useState('');
    const [priority, setPriority] = useState<'low' | 'normal' | 'high' | 'urgent'>('normal');
    const [targetType, setTargetType] = useState<'single_host' | 'ip_range' | 'domain' | 'subnet' | 'url' | 'network_segment' | 'asset_group'>('single_host');
    const [target, setTarget] = useState('');
    const [scanType, setScanType] = useState<'quick_scan' | 'full_scan' | 'stealth_scan' | 'aggressive_scan' | 'custom_scan'>('quick_scan');
    const [schedule, setSchedule] = useState<'immediate' | 'scheduled'>('immediate');
    const [scheduledTime, setScheduledTime] = useState('');
    const [customPorts, setCustomPorts] = useState('');

    // –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const [credentials, setCredentials] = useState<ScanCredentials>({
        username: '',
        password: '',
        domain: '',
        sshKey: '',
        apiToken: '',
        databaseConnectionString: ''
    });

    // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const [maxConcurrentScans, setMaxConcurrentScans] = useState(5);
    const [scanTimeout, setScanTimeout] = useState(30);
    const [retryAttempts, setRetryAttempts] = useState(3);
    const [rateLimiting, setRateLimiting] = useState(100);

    // AI –∏ ML –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const [neuralAssist, setNeuralAssist] = useState(true);
    const [aggressiveMode, setAggressiveMode] = useState(false);
    const [aiModels, setAiModels] = useState<AIModelsConfig>({
        anomalyDetection: true,
        behaviorAnalysis: false,
        patternRecognition: true,
        predictiveAnalysis: false,
        deepLearning: false,
        neuralNetworkEngine: 'TensorFlow'
    });

    // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –æ–ø—Ü–∏–∏
    const [advancedOptions, setAdvancedOptions] = useState<AdvancedOptions>({
        evasionTechniques: [],
        trafficAnalysis: false,
        deepPacketInspection: false,
        behavioralAnalysis: false,
        threatIntelligence: true,
        customPayloads: false,
        zeroDay: false,
        socialEngineering: false
    });

    // –ú–æ–¥—É–ª–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    const [scanModules, setScanModules] = useState<ScanModule[]>(initialScanModules);

    // –°–æ—Å—Ç–æ—è–Ω–∏—è UI
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [validationErrors, setValidationErrors] = useState<{ [key: string]: string }>({});
    const [activeTab, setActiveTab] = useState('basic');
    const [progressValue, setProgressValue] = useState(0);
    const [showAdvancedSettings, setShowAdvancedSettings] = useState(false);
    const [saveAsTemplate, setSaveAsTemplate] = useState(false);
    const [templateName, setTemplateName] = useState('');

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è Select –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï TypeScript –æ—à–∏–±–æ–∫)
    const handlePriorityChange = (value: string) => {
        if (['low', 'normal', 'high', 'urgent'].includes(value)) {
            setPriority(value as 'low' | 'normal' | 'high' | 'urgent');
        }
    };

    const handleTargetTypeChange = (value: string) => {
        const validOptions = ['single_host', 'ip_range', 'domain', 'subnet', 'url', 'network_segment', 'asset_group'];
        if (validOptions.includes(value)) {
            setTargetType(value as typeof targetType);
        }
    };

    const handleScanTypeChange = (value: string) => {
        const validOptions = ['quick_scan', 'full_scan', 'stealth_scan', 'aggressive_scan', 'custom_scan'];
        if (validOptions.includes(value)) {
            setScanType(value as typeof scanType);
        }
    };

    const handleScheduleChange = (value: string) => {
        const validOptions = ['immediate', 'scheduled'];
        if (validOptions.includes(value)) {
            setSchedule(value as typeof schedule);
        }
    };

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥—É–ª—è–º–∏
    const toggleModule = (moduleId: string) => {
        setScanModules(prev =>
            prev.map(module =>
                module.id === moduleId ? { ...module, enabled: !module.enabled } : module
            )
        );
        if (validationErrors.modules) {
            setValidationErrors(prev => ({ ...prev, modules: '' }));
        }
    };

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏
    const getIconComponent = (iconName: string) => {
        const iconMap: { [key: string]: React.ComponentType<any> } = {
            Target, Shield, Zap, Brain, Clock, CheckCircle, Settings, Save, Play,
            Calendar, Info, Wifi, Database, Globe, Network, Lock, Eye, Cpu, FileText,
            Activity, Search, Layers, Radio, Smartphone, Factory, Coins, Code, Bug,
            Fingerprint, Key, Server, Cloud, Router, Radar, Crosshair, Microscope,
            Monitor, HardDrive, AlertTriangle
        };
        return iconMap[iconName] || Shield;
    };

    const getSeverityColor = (severity: string) => {
        switch (severity) {
            case 'critical': return 'bg-red-600 text-white';
            case 'high': return 'bg-orange-600 text-white';
            case 'medium': return 'bg-yellow-500 text-black';
            case 'low': return 'bg-green-600 text-white';
            case 'informational': return 'bg-blue-500 text-white';
            default: return 'bg-gray-500 text-white';
        }
    };

    const getRiskLevelColor = (risk?: string) => {
        switch (risk) {
            case 'safe': return 'border border-green-300 bg-green-50 text-green-800';
            case 'moderate': return 'border border-yellow-300 bg-yellow-50 text-yellow-800';
            case 'aggressive': return 'border border-orange-300 bg-orange-50 text-orange-800';
            case 'destructive': return 'border border-red-300 bg-red-50 text-red-800';
            default: return 'border border-gray-300 bg-gray-50 text-gray-800';
        }
    };

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const getCategoryIconComponent = (category: string) => {
        const categoryIcons: { [key: string]: React.ComponentType<any> } = {
            basic: Target,
            advanced: Settings,
            ai: Brain,
            specialized: Crosshair,
            experimental: Microscope
        };
        return categoryIcons[category] || Shield;
    };

    const getEnabledModulesCount = () => {
        return scanModules.filter(m => m.enabled).length;
    };

    const getModulesByCategory = (category: string) => {
        return scanModules.filter(module => module.category === category);
    };

    const calculateTotalEstimatedTime = () => {
        const enabledModules = scanModules.filter(m => m.enabled);
        if (enabledModules.length === 0) return '0 –º–∏–Ω';

        const totalMinutes = enabledModules.reduce((total, module) => {
            const timeRange = module.estimatedTime.split('-');
            const maxTime = parseInt(timeRange[timeRange.length - 1]);
            return total + maxTime;
        }, 0);

        if (totalMinutes >= 60) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours}—á ${minutes}–º–∏–Ω`;
        }
        return `${totalMinutes} –º–∏–Ω`;
    };

    const calculateRiskScore = () => {
        const enabledModules = scanModules.filter(m => m.enabled);
        if (enabledModules.length === 0) return 0;

        const riskWeights = {
            'safe': 1,
            'moderate': 2,
            'aggressive': 3,
            'destructive': 4
        };

        const totalRisk = enabledModules.reduce((sum, module) => {
            return sum + (riskWeights[module.riskLevel || 'safe'] || 1);
        }, 0);

        return Math.min(100, (totalRisk / enabledModules.length) * 25);
    };

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    const validateForm = () => {
        const errors: { [key: string]: string } = {};

        if (!scanName.trim()) {
            errors.scanName = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è';
        }
        if (!target.trim()) {
            errors.target = '–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π –∞–¥—Ä–µ—Å –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω';
        }
        if (schedule === 'scheduled' && !scheduledTime) {
            errors.scheduledTime = '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è';
        }
        if (scanType === 'custom_scan' && !customPorts.trim()) {
            errors.customPorts = '–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ—Ä—Ç—ã –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è';
        }

        const enabledModules = scanModules.filter(m => m.enabled);
        if (enabledModules.length === 0) {
            errors.modules = '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –º–æ–¥—É–ª—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è';
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç—Ä–µ–±—É—é—â–∏–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏
        const credentialRequiredModules = enabledModules.filter(m => m.requiresCredentials);
        if (credentialRequiredModules.length > 0 && !credentials.username) {
            errors.credentials = '–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–¥—É–ª–∏ —Ç—Ä–µ–±—É—é—Ç —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
        }

        setValidationErrors(errors);
        return Object.keys(errors).length === 0;
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!validateForm()) {
            setError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ');
            return;
        }

        setLoading(true);
        setError('');

        try {
            // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            for (let i = 0; i <= 100; i += 10) {
                setProgressValue(i);
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            const scanConfig = {
                name: scanName,
                description: scanDescription,
                priority,
                targetType,
                target,
                scanType,
                schedule: {
                    type: schedule,
                    datetime: scheduledTime
                },
                customPorts,
                credentials,
                modules: scanModules.filter(m => m.enabled).map(m => m.id),
                maxConcurrentScans,
                scanTimeout,
                retryAttempts,
                rateLimiting,
                neuralAssist,
                aggressiveMode,
                aiModels,
                advancedOptions,
                saveAsTemplate,
                templateName: saveAsTemplate ? templateName : undefined
            };

            console.log('Advanced Scan Configuration:', scanConfig);

            // –†–µ–¥–∏—Ä–µ–∫—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            if (schedule === 'immediate') {
                router.push('/security/vulnerability-scanner/active-scan');
            } else {
                router.push('/security/vulnerability-scanner/scheduled-scans');
            }
        } catch (err) {
            setError('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        } finally {
            setLoading(false);
            setProgressValue(0);
        }
    };

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∫ —à–∞–±–ª–æ–Ω
    const handleSaveTemplate = async () => {
        if (!validateForm()) return;
        setLoading(true);
        try {
            await new Promise(resolve => setTimeout(resolve, 1000));
            alert('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
        } catch (err) {
            setError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞');
        } finally {
            setLoading(false);
        }
    };

    return (
        <TooltipProvider>
            <div className="max-w-6xl mx-auto p-6 space-y-6">
                {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
                <Card>
                    <CardHeader>
                        <div className="flex items-center justify-between">
                            <div>
                                <CardTitle className="text-2xl flex items-center gap-2">
                                    <Shield className="w-6 h-6" />
                                    –ù–æ–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - Advanced Penetration Testing
                                </CardTitle>
                                <p className="text-muted-foreground mt-1">
                                    –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ
                                </p>
                            </div>
                            <div className="flex items-center gap-2">
                                <Badge className="border border-green-300 bg-green-50 text-green-700">
                                    <Brain className="w-4 h-4 mr-1" />
                                    Neural: –ê–∫—Ç–∏–≤–µ–Ω
                                </Badge>
                                <Badge className="border border-blue-300 bg-blue-50 text-blue-700">
                                    –ú–æ–¥—É–ª–µ–π: {getEnabledModulesCount()}
                                </Badge>
                            </div>
                        </div>

                        {/* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */}
                        {loading && (
                            <div className="mt-4">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-sm text-muted-foreground">
                                        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...
                                    </span>
                                    <span className="text-sm font-medium">{progressValue}%</span>
                                </div>
                                <Progress value={progressValue} className="h-2" />
                            </div>
                        )}
                    </CardHeader>
                </Card>

                <form onSubmit={handleSubmit}>
                    <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
                        <TabsList className="grid grid-cols-5 w-full">
                            <TabsTrigger value="basic">–û—Å–Ω–æ–≤–Ω–æ–µ</TabsTrigger>
                            <TabsTrigger value="modules">–ú–æ–¥—É–ª–∏</TabsTrigger>
                            <TabsTrigger value="advanced">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ</TabsTrigger>
                            <TabsTrigger value="ai">–ò–ò & ML</TabsTrigger>
                            <TabsTrigger value="review">–û–±–∑–æ—Ä</TabsTrigger>
                        </TabsList>

                        {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                        <TabsContent value="basic">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <Card>
                                    <CardHeader>
                                        <CardTitle>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-4">
                                        <div>
                                            <Label htmlFor="scanName">–ù–∞–∑–≤–∞–Ω–∏–µ *</Label>
                                            <Input
                                                id="scanName"
                                                value={scanName}
                                                onChange={(e) => setScanName(e.target.value)}
                                                className={validationErrors.scanName ? 'border-red-500' : ''}
                                                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∏"
                                            />
                                            {validationErrors.scanName && (
                                                <p className="text-sm text-red-600 mt-1">{validationErrors.scanName}</p>
                                            )}
                                        </div>

                                        <div>
                                            <Label htmlFor="priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</Label>
                                            <Select value={priority} onValueChange={handlePriorityChange}>
                                                <SelectTrigger>
                                                    <SelectValue />
                                                </SelectTrigger>
                                                <SelectContent>
                                                    <SelectItem value="low">üü¢ –ù–∏–∑–∫–∏–π</SelectItem>
                                                    <SelectItem value="normal">üü° –û–±—ã—á–Ω—ã–π</SelectItem>
                                                    <SelectItem value="high">üü† –í—ã—Å–æ–∫–∏–π</SelectItem>
                                                    <SelectItem value="urgent">üî¥ –°—Ä–æ—á–Ω—ã–π</SelectItem>
                                                </SelectContent>
                                            </Select>
                                        </div>

                                        <div>
                                            <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ</Label>
                                            <Textarea
                                                id="description"
                                                value={scanDescription}
                                                onChange={(e) => setScanDescription(e.target.value)}
                                                rows={3}
                                                placeholder="–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–µ–π –∏ –∑–∞–¥–∞—á —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è..."
                                            />
                                        </div>
                                    </CardContent>
                                </Card>

                                <Card>
                                    <CardHeader>
                                        <CardTitle>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–ª–∏</CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-4">
                                        <div>
                                            <Label>–¢–∏–ø —Ü–µ–ª–∏ *</Label>
                                            <Select value={targetType} onValueChange={handleTargetTypeChange}>
                                                <SelectTrigger>
                                                    <SelectValue />
                                                </SelectTrigger>
                                                <SelectContent>
                                                    <SelectItem value="single_host">üñ•Ô∏è –û–¥–∏–Ω–æ—á–Ω—ã–π —Ö–æ—Å—Ç</SelectItem>
                                                    <SelectItem value="ip_range">üìä –î–∏–∞–ø–∞–∑–æ–Ω IP</SelectItem>
                                                    <SelectItem value="domain">üåê –î–æ–º–µ–Ω</SelectItem>
                                                    <SelectItem value="subnet">üîó –ü–æ–¥—Å–µ—Ç—å</SelectItem>
                                                    <SelectItem value="url">üîó URL</SelectItem>
                                                    <SelectItem value="network_segment">üì° –°–µ–≥–º–µ–Ω—Ç —Å–µ—Ç–∏</SelectItem>
                                                    <SelectItem value="asset_group">üìã –ì—Ä—É–ø–ø–∞ –∞–∫—Ç–∏–≤–æ–≤</SelectItem>
                                                </SelectContent>
                                            </Select>
                                        </div>

                                        <div>
                                            <Label htmlFor="target">–ê–¥—Ä–µ—Å —Ü–µ–ª–∏ *</Label>
                                            <Input
                                                id="target"
                                                value={target}
                                                onChange={(e) => setTarget(e.target.value)}
                                                className={validationErrors.target ? 'border-red-500' : ''}
                                                placeholder={
                                                    targetType === 'single_host' ? '192.168.1.100' :
                                                        targetType === 'ip_range' ? '192.168.1.1-192.168.1.254' :
                                                            targetType === 'domain' ? 'example.com' :
                                                                targetType === 'subnet' ? '192.168.1.0/24' :
                                                                    targetType === 'url' ? 'https://example.com' :
                                                                        '–£–∫–∞–∂–∏—Ç–µ —Ü–µ–ª—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è'
                                                }
                                            />
                                            {validationErrors.target && (
                                                <p className="text-sm text-red-600 mt-1">{validationErrors.target}</p>
                                            )}
                                        </div>

                                        <div>
                                            <Label>–¢–∏–ø —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</Label>
                                            <Select value={scanType} onValueChange={handleScanTypeChange}>
                                                <SelectTrigger>
                                                    <SelectValue />
                                                </SelectTrigger>
                                                <SelectContent>
                                                    <SelectItem value="quick_scan">‚ö° –ë—ã—Å—Ç—Ä–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (5-15 –º–∏–Ω)</SelectItem>
                                                    <SelectItem value="full_scan">üîç –ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (30-60 –º–∏–Ω)</SelectItem>
                                                    <SelectItem value="stealth_scan">üëª –°–∫—Ä—ã—Ç–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (60+ –º–∏–Ω)</SelectItem>
                                                    <SelectItem value="aggressive_scan">üí• –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (45+ –º–∏–Ω)</SelectItem>
                                                    <SelectItem value="custom_scan">‚öôÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</SelectItem>
                                                </SelectContent>
                                            </Select>
                                        </div>

                                        <div>
                                            <Label>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</Label>
                                            <Select value={schedule} onValueChange={handleScheduleChange}>
                                                <SelectTrigger>
                                                    <SelectValue />
                                                </SelectTrigger>
                                                <SelectContent>
                                                    <SelectItem value="immediate">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ</SelectItem>
                                                    <SelectItem value="scheduled">üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</SelectItem>
                                                </SelectContent>
                                            </Select>

                                            {schedule === 'scheduled' && (
                                                <div className="mt-2">
                                                    <Label htmlFor="scheduledTime">–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ *</Label>
                                                    <Input
                                                        id="scheduledTime"
                                                        type="datetime-local"
                                                        value={scheduledTime}
                                                        onChange={(e) => setScheduledTime(e.target.value)}
                                                        className={validationErrors.scheduledTime ? 'border-red-500' : ''}
                                                    />
                                                    {validationErrors.scheduledTime && (
                                                        <p className="text-sm text-red-600 mt-1">{validationErrors.scheduledTime}</p>
                                                    )}
                                                </div>
                                            )}
                                        </div>

                                        {scanType === 'custom_scan' && (
                                            <div>
                                                <Label htmlFor="customPorts">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ—Ä—Ç—ã *</Label>
                                                <Input
                                                    id="customPorts"
                                                    value={customPorts}
                                                    onChange={(e) => setCustomPorts(e.target.value)}
                                                    className={validationErrors.customPorts ? 'border-red-500' : ''}
                                                    placeholder="22,80,443,8080-8090"
                                                />
                                                {validationErrors.customPorts && (
                                                    <p className="text-sm text-red-600 mt-1">{validationErrors.customPorts}</p>
                                                )}
                                            </div>
                                        )}
                                    </CardContent>
                                </Card>
                            </div>
                        </TabsContent>

                        {/* –ú–æ–¥—É–ª–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */}
                        <TabsContent value="modules">
                            <Card>
                                <CardHeader>
                                    <div className="flex items-center justify-between">
                                        <CardTitle>–ú–æ–¥—É–ª–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</CardTitle>
                                        <div className="flex items-center gap-4">
                                            <div className="text-sm text-muted-foreground">
                                                –í—Ä–µ–º—è: <Badge className="border border-blue-300 bg-blue-50 text-blue-700">
                                                    {calculateTotalEstimatedTime()}
                                                </Badge>
                                            </div>
                                            <div className="text-sm text-muted-foreground">
                                                –†–∏—Å–∫: <Badge className="border border-orange-300 bg-orange-50 text-orange-700">
                                                    {calculateRiskScore().toFixed(0)}%
                                                </Badge>
                                            </div>
                                        </div>
                                    </div>
                                    {validationErrors.modules && (
                                        <Alert>
                                            <AlertTriangle className="h-4 w-4" />
                                            <AlertDescription className="text-red-600">
                                                {validationErrors.modules}
                                            </AlertDescription>
                                        </Alert>
                                    )}
                                </CardHeader>
                                <CardContent>
                                    <Accordion type="multiple" className="space-y-4">
                                        {['basic', 'advanced', 'ai', 'specialized', 'experimental'].map(category => {
                                            const categoryModules = getModulesByCategory(category);
                                            const enabledCount = categoryModules.filter(m => m.enabled).length;
                                            const CategoryIcon = getCategoryIconComponent(category);

                                            return (
                                                <AccordionItem key={category} value={category}>
                                                    <AccordionTrigger className="hover:no-underline">
                                                        <div className="flex items-center justify-between w-full pr-4">
                                                            <div className="flex items-center gap-2">
                                                                <CategoryIcon className="w-5 h-5" />
                                                                <span className="font-semibold capitalize">
                                                                    {category === 'basic' ? '–ë–∞–∑–æ–≤—ã–µ' :
                                                                        category === 'advanced' ? '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ' :
                                                                            category === 'ai' ? '–ò–ò-–º–æ–¥—É–ª–∏' :
                                                                                category === 'specialized' ? '–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ' :
                                                                                    '–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ'}
                                                                </span>
                                                            </div>
                                                            <Badge className="border border-gray-300 bg-gray-50 text-gray-700">
                                                                {enabledCount}/{categoryModules.length}
                                                            </Badge>
                                                        </div>
                                                    </AccordionTrigger>
                                                    <AccordionContent>
                                                        <ScrollArea className="h-96">
                                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-2">
                                                                {categoryModules.map((module) => {
                                                                    const Icon = getIconComponent(module.icon);
                                                                    const CategoryIcon = getCategoryIconComponent(module.category);

                                                                    return (
                                                                        <Tooltip key={module.id}>
                                                                            <TooltipTrigger asChild>
                                                                                <Card
                                                                                    className={`cursor-pointer transition-all hover:shadow-md ${module.enabled ? 'ring-2 ring-blue-500 bg-blue-50' : 'hover:bg-gray-50'
                                                                                        }`}
                                                                                    onClick={() => toggleModule(module.id)}
                                                                                >
                                                                                    <CardContent className="p-4">
                                                                                        <div className="flex items-start justify-between mb-2">
                                                                                            <div className="flex items-center space-x-2">
                                                                                                <Icon className="w-5 h-5 text-gray-600" />
                                                                                                <CategoryIcon className="w-4 h-4 text-gray-400" />
                                                                                            </div>
                                                                                            <div className="flex items-center space-x-1">
                                                                                                {module.enabled && <CheckCircle className="w-4 h-4 text-green-600" />}
                                                                                                <Badge className={getSeverityColor(module.severity)}>
                                                                                                    {module.severity}
                                                                                                </Badge>
                                                                                            </div>
                                                                                        </div>

                                                                                        <h4 className="font-semibold text-sm mb-1">{module.name}</h4>
                                                                                        <p className="text-xs text-gray-600 mb-2 line-clamp-2">{module.description}</p>

                                                                                        <div className="flex items-center justify-between text-xs">
                                                                                            <span className="text-gray-500">‚è±Ô∏è {module.estimatedTime}</span>
                                                                                            {module.riskLevel && (
                                                                                                <Badge className={getRiskLevelColor(module.riskLevel)}>
                                                                                                    {module.riskLevel}
                                                                                                </Badge>
                                                                                            )}
                                                                                        </div>

                                                                                        {module.requiresCredentials && (
                                                                                            <div className="mt-2">
                                                                                                <Badge className="border border-orange-300 bg-orange-50 text-orange-700">
                                                                                                    üîê –¢—Ä–µ–±—É—é—Ç—Å—è —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                                                                                                </Badge>
                                                                                            </div>
                                                                                        )}
                                                                                    </CardContent>
                                                                                </Card>
                                                                            </TooltipTrigger>
                                                                            <TooltipContent>
                                                                                <p className="max-w-xs">{module.description}</p>
                                                                            </TooltipContent>
                                                                        </Tooltip>
                                                                    );
                                                                })}
                                                            </div>
                                                        </ScrollArea>
                                                    </AccordionContent>
                                                </AccordionItem>
                                            );
                                        })}
                                    </Accordion>
                                </CardContent>
                            </Card>
                        </TabsContent>

                        {/* –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ */}
                        <TabsContent value="advanced">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <Card>
                                    <CardHeader>
                                        <CardTitle>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-4">
                                        <div>
                                            <Label htmlFor="maxConcurrent">–ú–∞–∫—Å–∏–º—É–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</Label>
                                            <Input
                                                id="maxConcurrent"
                                                type="number"
                                                value={maxConcurrentScans}
                                                onChange={(e) => setMaxConcurrentScans(parseInt(e.target.value))}
                                                min="1"
                                                max="50"
                                            />
                                        </div>

                                        <div>
                                            <Label htmlFor="timeout">–¢–∞–π–º-–∞—É—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–º–∏–Ω—É—Ç—ã)</Label>
                                            <Input
                                                id="timeout"
                                                type="number"
                                                value={scanTimeout}
                                                onChange={(e) => setScanTimeout(parseInt(e.target.value))}
                                                min="5"
                                                max="1440"
                                            />
                                        </div>

                                        <div>
                                            <Label htmlFor="retries">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫</Label>
                                            <Input
                                                id="retries"
                                                type="number"
                                                value={retryAttempts}
                                                onChange={(e) => setRetryAttempts(parseInt(e.target.value))}
                                                min="0"
                                                max="10"
                                            />
                                        </div>

                                        <div>
                                            <Label htmlFor="rateLimit">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ (–ø–∞–∫–µ—Ç–æ–≤/—Å–µ–∫)</Label>
                                            <Input
                                                id="rateLimit"
                                                type="number"
                                                value={rateLimiting}
                                                onChange={(e) => setRateLimiting(parseInt(e.target.value))}
                                                min="1"
                                                max="10000"
                                            />
                                        </div>
                                    </CardContent>
                                </Card>

                                <Card>
                                    <CardHeader>
                                        <CardTitle>
                                            <div className="flex items-center justify-between">
                                                –¢–µ—Ö–Ω–∏–∫–∏ —É–∫–ª–æ–Ω–µ–Ω–∏—è
                                                <Tooltip>
                                                    <TooltipTrigger>
                                                        <HelpCircle className="w-4 h-4 text-gray-400" />
                                                    </TooltipTrigger>
                                                    <TooltipContent>
                                                        <p>–ú–µ—Ç–æ–¥—ã –¥–ª—è –æ–±—Ö–æ–¥–∞ —Å–∏—Å—Ç–µ–º –∑–∞—â–∏—Ç—ã</p>
                                                    </TooltipContent>
                                                </Tooltip>
                                            </div>
                                        </CardTitle>
                                    </CardHeader>
                                    <CardContent>
                                        <Collapsible open={showAdvancedSettings} onOpenChange={setShowAdvancedSettings}>
                                            <CollapsibleTrigger asChild>
                                                <Button variant="ghost" className="w-full justify-between">
                                                    –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫–∏ —É–∫–ª–æ–Ω–µ–Ω–∏—è
                                                    {showAdvancedSettings ? <ChevronUp /> : <ChevronDown />}
                                                </Button>
                                            </CollapsibleTrigger>
                                            <CollapsibleContent className="space-y-2 mt-4">
                                                <div className="grid grid-cols-1 gap-2">
                                                    {evasionTechniques.map((technique) => (
                                                        <div key={technique} className="flex items-center space-x-2">
                                                            <Switch
                                                                checked={advancedOptions.evasionTechniques.includes(technique)}
                                                                onCheckedChange={(checked) => {
                                                                    if (checked) {
                                                                        setAdvancedOptions(prev => ({
                                                                            ...prev,
                                                                            evasionTechniques: [...prev.evasionTechniques, technique]
                                                                        }));
                                                                    } else {
                                                                        setAdvancedOptions(prev => ({
                                                                            ...prev,
                                                                            evasionTechniques: prev.evasionTechniques.filter(t => t !== technique)
                                                                        }));
                                                                    }
                                                                }}
                                                            />
                                                            <Label className="text-sm">{technique}</Label>
                                                        </div>
                                                    ))}
                                                </div>
                                            </CollapsibleContent>
                                        </Collapsible>
                                    </CardContent>
                                </Card>

                                <Card>
                                    <CardHeader>
                                        <CardTitle>–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-4">
                                        <div>
                                            <Label htmlFor="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</Label>
                                            <Input
                                                id="username"
                                                value={credentials.username}
                                                onChange={(e) => setCredentials(prev => ({ ...prev, username: e.target.value }))}
                                                placeholder="admin"
                                            />
                                        </div>

                                        <div>
                                            <Label htmlFor="password">–ü–∞—Ä–æ–ª—å</Label>
                                            <Input
                                                id="password"
                                                type="password"
                                                value={credentials.password}
                                                onChange={(e) => setCredentials(prev => ({ ...prev, password: e.target.value }))}
                                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                            />
                                        </div>

                                        <div>
                                            <Label htmlFor="domain">–î–æ–º–µ–Ω</Label>
                                            <Input
                                                id="domain"
                                                value={credentials.domain}
                                                onChange={(e) => setCredentials(prev => ({ ...prev, domain: e.target.value }))}
                                                placeholder="WORKGROUP"
                                            />
                                        </div>

                                        {validationErrors.credentials && (
                                            <Alert>
                                                <AlertTriangle className="h-4 w-4" />
                                                <AlertDescription className="text-red-600">
                                                    {validationErrors.credentials}
                                                </AlertDescription>
                                            </Alert>
                                        )}
                                    </CardContent>
                                </Card>

                                <Card>
                                    <CardHeader>
                                        <CardTitle>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏</CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-4">
                                        <div className="flex items-center justify-between">
                                            <Label>–ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ñ–∏–∫–∞</Label>
                                            <Switch
                                                checked={advancedOptions.trafficAnalysis}
                                                onCheckedChange={(checked) => setAdvancedOptions(prev => ({ ...prev, trafficAnalysis: checked }))}
                                            />
                                        </div>

                                        <div className="flex items-center justify-between">
                                            <Label>–ì–ª—É–±–æ–∫–∞—è –∏–Ω—Å–ø–µ–∫—Ü–∏—è –ø–∞–∫–µ—Ç–æ–≤</Label>
                                            <Switch
                                                checked={advancedOptions.deepPacketInspection}
                                                onCheckedChange={(checked) => setAdvancedOptions(prev => ({ ...prev, deepPacketInspection: checked }))}
                                            />
                                        </div>

                                        <div className="flex items-center justify-between">
                                            <Label>–ê–Ω–∞–ª–∏–∑ —É–≥—Ä–æ–∑</Label>
                                            <Switch
                                                checked={advancedOptions.threatIntelligence}
                                                onCheckedChange={(checked) => setAdvancedOptions(prev => ({ ...prev, threatIntelligence: checked }))}
                                            />
                                        </div>

                                        <div className="flex items-center justify-between">
                                            <Label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏</Label>
                                            <Switch
                                                checked={advancedOptions.customPayloads}
                                                onCheckedChange={(checked) => setAdvancedOptions(prev => ({ ...prev, customPayloads: checked }))}
                                            />
                                        </div>

                                        <div className="flex items-center justify-between">
                                            <Label>–ü–æ–∏—Å–∫ Zero-Day</Label>
                                            <Switch
                                                checked={advancedOptions.zeroDay}
                                                onCheckedChange={(checked) => setAdvancedOptions(prev => ({ ...prev, zeroDay: checked }))}
                                            />
                                        </div>
                                    </CardContent>
                                </Card>
                            </div>
                        </TabsContent>

                        {/* –ò–ò –∏ ML –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ */}
                        <TabsContent value="ai">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <Card>
                                    <CardHeader>
                                        <CardTitle>–ú–æ–¥–µ–ª–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞</CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-4">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <Label>–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π</Label>
                                                <p className="text-sm text-gray-600">–ü–æ–∏—Å–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã</p>
                                            </div>
                                            <Switch
                                                checked={aiModels.anomalyDetection}
                                                onCheckedChange={(checked) => setAiModels(prev => ({ ...prev, anomalyDetection: checked }))}
                                            />
                                        </div>

                                        <Separator />

                                        <div className="flex items-center justify-between">
                                            <div>
                                                <Label>–ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑</Label>
                                                <p className="text-sm text-gray-600">–ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                                            </div>
                                            <Switch
                                                checked={aiModels.behaviorAnalysis}
                                                onCheckedChange={(checked) => setAiModels(prev => ({ ...prev, behaviorAnalysis: checked }))}
                                            />
                                        </div>

                                        <Separator />

                                        <div className="flex items-center justify-between">
                                            <div>
                                                <Label>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</Label>
                                                <p className="text-sm text-gray-600">–í—ã—è–≤–ª–µ–Ω–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∞—Ç–∞–∫</p>
                                            </div>
                                            <Switch
                                                checked={aiModels.patternRecognition}
                                                onCheckedChange={(checked) => setAiModels(prev => ({ ...prev, patternRecognition: checked }))}
                                            />
                                        </div>

                                        <Separator />

                                        <div className="flex items-center justify-between">
                                            <div>
                                                <Label>–ü—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑</Label>
                                                <p className="text-sm text-gray-600">–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≥—Ä–æ–∑</p>
                                            </div>
                                            <Switch
                                                checked={aiModels.predictiveAnalysis}
                                                onCheckedChange={(checked) => setAiModels(prev => ({ ...prev, predictiveAnalysis: checked }))}
                                            />
                                        </div>

                                        <Separator />

                                        <div className="flex items-center justify-between">
                                            <div>
                                                <Label>–ì–ª—É–±–æ–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ</Label>
                                                <p className="text-sm text-gray-600">–ù–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–µ—Ç–∏ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á</p>
                                            </div>
                                            <Switch
                                                checked={aiModels.deepLearning}
                                                onCheckedChange={(checked) => setAiModels(prev => ({ ...prev, deepLearning: checked }))}
                                            />
                                        </div>
                                    </CardContent>
                                </Card>

                                <Card>
                                    <CardHeader>
                                        <CardTitle>–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–ò</CardTitle>
                                    </CardHeader>
                                    <CardContent className="space-y-4">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <Label>Neural Network Assistance</Label>
                                                <p className="text-sm text-gray-600">–ò–ò-–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π</p>
                                            </div>
                                            <Switch
                                                checked={neuralAssist}
                                                onCheckedChange={setNeuralAssist}
                                            />
                                        </div>

                                        <Separator />

                                        <div className="flex items-center justify-between">
                                            <div>
                                                <Label>–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º</Label>
                                                <p className="text-sm text-gray-600">–ë–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ò–ò</p>
                                            </div>
                                            <Switch
                                                checked={aggressiveMode}
                                                onCheckedChange={setAggressiveMode}
                                            />
                                        </div>

                                        <Separator />

                                        <div className="flex items-center justify-between">
                                            <div>
                                                <Label>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω</Label>
                                                <p className="text-sm text-gray-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</p>
                                            </div>
                                            <Switch
                                                checked={saveAsTemplate}
                                                onCheckedChange={setSaveAsTemplate}
                                            />
                                        </div>

                                        {saveAsTemplate && (
                                            <div>
                                                <Label htmlFor="templateName">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</Label>
                                                <Input
                                                    id="templateName"
                                                    value={templateName}
                                                    onChange={(e) => setTemplateName(e.target.value)}
                                                    placeholder="–ú–æ–π —à–∞–±–ª–æ–Ω —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"
                                                />
                                            </div>
                                        )}
                                    </CardContent>
                                </Card>
                            </div>
                        </TabsContent>

                        {/* –û–±–∑–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ */}
                        <TabsContent value="review">
                            <Card>
                                <CardHeader>
                                    <CardTitle>–û–±–∑–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</CardTitle>
                                </CardHeader>
                                <CardContent className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                            <h4 className="font-semibold text-blue-900">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                                            <p className="text-sm text-blue-700">–ù–∞–∑–≤–∞–Ω–∏–µ: {scanName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                                            <p className="text-sm text-blue-700">–¶–µ–ª—å: {target || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                                            <p className="text-sm text-blue-700">–¢–∏–ø: {scanType}</p>
                                            <p className="text-sm text-blue-700">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {priority}</p>
                                        </div>

                                        <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                            <h4 className="font-semibold text-green-900">–ú–æ–¥—É–ª–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h4>
                                            <p className="text-sm text-green-700">
                                                –í—ã–±—Ä–∞–Ω–æ: {scanModules.filter(m => m.enabled).length} –∏–∑ {scanModules.length}
                                            </p>
                                            <p className="text-sm text-green-700">–í—Ä–µ–º—è: {calculateTotalEstimatedTime()}</p>
                                            <p className="text-sm text-green-700">–†–∏—Å–∫: {calculateRiskScore().toFixed(0)}%</p>
                                        </div>

                                        <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                            <h4 className="font-semibold text-purple-900">–ò–ò –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
                                            <p className="text-sm text-purple-700">
                                                Neural Assist: {neuralAssist ? '–í–∫–ª—é—á–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω'}
                                            </p>
                                            <p className="text-sm text-purple-700">
                                                –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º: {aggressiveMode ? '–í–∫–ª—é—á–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω'}
                                            </p>
                                            <p className="text-sm text-purple-700">
                                                –¢–µ—Ö–Ω–∏–∫–∏ —É–∫–ª–æ–Ω–µ–Ω–∏—è: {advancedOptions.evasionTechniques.length}
                                            </p>
                                        </div>
                                    </div>

                                    <Separator />

                                    <div>
                                        <h4 className="font-semibold mb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –º–æ–¥—É–ª–∏:</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                            {scanModules.filter(m => m.enabled).map(module => (
                                                <Badge key={module.id} className="border border-blue-300 bg-blue-50 text-blue-700 justify-start">
                                                    {module.name}
                                                </Badge>
                                            ))}
                                        </div>

                                        {scanModules.filter(m => m.enabled).length === 0 && (
                                            <p className="text-gray-500 italic">–ú–æ–¥—É–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</p>
                                        )}
                                    </div>

                                    {error && (
                                        <Alert>
                                            <AlertTriangle className="w-5 h-5 text-red-600" />
                                            <AlertDescription className="text-red-800">
                                                {error}
                                            </AlertDescription>
                                        </Alert>
                                    )}

                                    <div className="flex justify-end space-x-4">
                                        {saveAsTemplate && (
                                            <Button
                                                type="button"
                                                variant="outline"
                                                onClick={handleSaveTemplate}
                                                disabled={loading}
                                            >
                                                <Save className="mr-2 w-4 h-4" />
                                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω
                                            </Button>
                                        )}

                                        <Button type="submit" disabled={loading} size="lg">
                                            {loading ? (
                                                <>
                                                    <Loader2 className="mr-2 w-4 h-4 animate-spin" />
                                                    –ó–∞–ø—É—Å–∫...
                                                </>
                                            ) : (
                                                <>
                                                    {schedule === 'immediate' ? (
                                                        <Play className="mr-2 w-4 h-4" />
                                                    ) : (
                                                        <Calendar className="mr-2 w-4 h-4" />
                                                    )}
                                                    {schedule === 'immediate' ? '–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ'}
                                                </>
                                            )}
                                        </Button>
                                    </div>
                                </CardContent>
                            </Card>
                        </TabsContent>
                    </Tabs>
                </form>
            </div>
        </TooltipProvider>
    );
};

export default NewScanPage;
